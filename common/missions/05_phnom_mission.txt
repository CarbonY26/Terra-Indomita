phnom_mission_tree = {
    header = "mission_image_china"
    icon = "cde_gallic_village"

    repeatable = no
	
    chance = {
        factor = 5
    }

    potential = {
        NOT = { has_variable = mission_cooldown_var }
        tag = PHN
		is_subject = no
        has_civil_war = no
		#always = no
    }

    abort = {
		ai_mission_back_out_trigger = yes
	}
	
    on_start = {
        start_mission_ai_effect = yes
		trigger_event = me_phnom.1
    }
	
    on_abort = {
        custom_tooltip = general_mission_cooldown_tt
        set_variable = {
            name = mission_cooldown_var
            days = 7300
        }
    }
	
    on_completion = {
		capital_scope = {
            capital_formable_small_effect = yes
        }
        complete_mission_effect = yes
    }
	
    phnom_mission_tree_task_1 = { #Colonizing The Mekong Delta
        icon = "task_political"
		duration = 180
		
        allow = {
            political_influence >= 25
        }
		
        on_completion = {
			add_political_influence = -25
            trigger_event = me_phnom.3
            show_as_tooltip = {
				add_country_modifier = {
					name = phnom_cheaper_slaves_cost
					duration = 7300 #20 years
				}
				add_country_modifier = {
					name = phnom_expanded_diplo_mod_1
					duration = -1
				}
            }
        }
    }
	
    phnom_mission_tree_task_2 = { #Protection Against Yan
        icon = "task_battle"
		requires = { phnom_mission_tree_task_1 }
		duration = 550
		
		highlight = {
            scope:province = {
                province_id = 8773
            }
        }
		
        allow = {
			trigger_if = {
                limit = {
                    c:MRY = { has_land = yes }
                }
                trigger_if = {
                    limit = {
                        char:66 = { is_alive = yes}
                    }
                    char:66 = { age <= 75 }
                }
                trigger_else_if = {
                    limit = {
                        char:66 = { is_alive = no }
                    }
                    current_ruler = {
                        any_child = {
                            is_alive = yes
                            is_male = yes
                        }
                    }
                }
            	c:MRY = {
            		opinion = {
            			target = c:PHN
            			value >= 30
            		}
                    any_character = {
                        has_trait = maurya
                        is_female = yes
                        age <= 40
                        age > 15
                    }
            	}
            }
            trigger_else = {
                c:MRY = { has_land = no }
            }
        }
		
        on_completion = {
            if = {
                limit = {
                    c:MRY = { has_land = yes }
                }
                trigger_event = me_phnom.4
                show_as_tooltip = {
                    if = {
                        limit = {
                            c:MRY = { has_land = yes }
                            char:66 = { is_alive = yes }
                        }
                        #Marry an Achaemenid character to Zipoetes son if he is alive, otherwise marry a random child.
                        custom_tooltip  = phnom_missions_task_2_tt
                        if = {
                            limit = {
                                char:38024 = { is_married = yes }
                            }
                            char:38024 = { divorce_character = spouse }
                        }
                        c:MRY = {
                            random_character = {
                                limit = {
                                    has_trait = maurya
                                    is_female = yes
                                    age <= 40
                                    age > 15
                                }
                                if = {
                                    limit = { is_married = yes }
                                    divorce_character = spouse
                                }
                                save_scope_as = marriage_partner
                            }
                        }
                        char:38024 = { marry_character = scope:marriage_partner }
                    }
                    else_if = {
                        limit = {
                            c:MRY = { has_land = yes }
                            current_ruler = {
                                any_child = {
                                    is_alive = yes
                                    is_male = yes
                                    age >= 16
                                }
                            }
                        }
                        c:MRY = {
                            random_character = {
                                limit = {
                                    has_trait = maurya
                                    is_female = yes
                                    age <= 40
                                    age > 15
                                }
                                if = {
                                    limit = { is_married = yes }
                                    divorce_character = spouse
                                }
                                save_scope_as = marriage_partner
                            }
                        }
                        current_ruler = {
                            ordered_child = {
                                limit = {
                                    age >= 16
                                    is_male = yes
                                    is_alive = yes
                                }
                                order_by = age
                                position = end
                                if = {
                                    limit = { is_married = yes }
                                    divorce_character = spouse
                                }
                                marry_character = scope:marriage_partner
                            }
                        }
                    }
                }
            }

            else = {
                add_treasury = 100
                current_ruler = {
                    add_popularity = 5
                }
            }
			add_country_modifier = {
				name = phnom_maurya_marriage_trade_connection_mod
				duration = -1
			}
        }
    }
	
    phnom_mission_tree_task_3 = { #The Province of Funan
        icon = "task_battle"
		duration = 180

        allow = {
            political_influence >= 15
        }
		
        on_completion = {
			add_political_influence = -15
            trigger_event = me_phnom.6
			area:chenla_area = {
                add_provincial_claim_effect = yes
			}
            p:9833 = { set_owned_by = root }
			p:9827 = { add_claim = root }
        }
    }
	
    phnom_mission_tree_task_4 = { #sister cities
        icon = "task_economical"
		duration = 730
        requires = { phnom_mission_tree_task_1 phnom_mission_tree_task_3 }
		
		highlight = {
            scope:province = {
                province_id = 9829
            }
        }
		
        allow = {
			political_influence >= 40
			treasury >= 150
			p:9829.state = {
                calc_true_if = {
                    amount >= 1
                    state_improvement_military_trigger = yes
                    state_improvement_civic_trigger = yes
                    state_improvement_oratory_trigger = yes
                    state_improvement_religious_trigger = yes
                }
            }
			p:9829 = {
				total_population >= 10
			}
        }
		
        on_completion = {
			add_political_influence = -40
			add_treasury = -150
            trigger_event = me_phnom.7
            show_as_tooltip = {
                p:9829 = {set_city_status = city}
            }
			p:9828 = {
				add_road_towards = 9829
			}
			add_country_modifier = {
				name = phnom_expanded_diplo_mod_2
				duration = -1
			}
        }
    }
	
    phnom_mission_tree_task_5 = { #Court of phnom
        icon = "task_diplomatic"
        requires = { phnom_mission_tree_task_4 }
        duration = 730
		
        highlight = {
			scope:province = {
				OR = {
					province_id = 11015
					province_id = 11014
					province_id = 11002
					province_id = 11003
				}
			}
		}
		
        allow = {
            political_influence >= 40
            hidden:capital_scope = {
				has_building = forum_building
				has_province_modifier = merchant_in_province_mod
			}
        }
		
        on_completion = {
            add_political_influence = -40
            trigger_event = me_phnom.8
                p:11015 = { set_owned_by = root }
                p:11014 = { set_owned_by = root }
                p:11002 = { set_owned_by = root }
                p:11003 = { set_owned_by = root }
        }
    }
	
    phnom_mission_tree_task_6 = { #Claiming The Coasts
        icon = "task_expansion"
        requires = { phnom_mission_tree_task_5 }

        highlight = {
            scope:province = {
                province_id = 9828
            }
        }
		
        allow = {
			num_of_ships >= 40
			hidden:capital_scope = {
				has_building = military_harbor_building
				has_province_modifier = architect_in_province_mod
				num_of_port_building >= 2
			}
        }
		
        on_completion = {
            trigger_event = me_phnom.9
            add_country_modifier = {
                name = phnom_expanded_diplo_mod_3
                duration = -1
            }
            show_as_tooltip = {
                capital_scope = {
                    add_permanent_province_modifier = {
                        name = phnom_harbor_mod
                    }
                }
                custom_tooltip = phnom_mission_tree_task_6_tt
                hidden_effect = {
                    region:funan_region = {
                        every_region_province = { add_claim = ROOT }
                    }
                }
            }
        }
    }
	
    phnom_mission_tree_task_7 = { # Advancements In Production
        icon = "task_calm"
        requires = { phnom_mission_tree_task_5 }
		
        allow = {
            has_law = coin_minting_law
            has_law = formalized_industry_law_tribal
            hidden:p:11015 = {has_building = slave_mine_building}
            hidden:p:11014 = {has_building = hunting_camps}
        }
		
		highlight = {
			scope:province = {
				OR = {
					province_id = 11015
                    province_id = 11014
				}
			}
		}
		
        on_completion = {
            trigger_event = me_phnom.10
            p:11015 = {
                add_permanent_province_modifier = {
                    name = phnom_expanded_mines_mod
                    duration = -1
                }
            }
            p:11014 = {
                add_permanent_province_modifier = {
                    name = phnom_expanded_hunting_mod
                    duration = -1
                }
            }
            show_as_tooltip = {
                add_treasury = 100
                add_centralization = 10
                add_stability = 5
            }
        }
    }
	
    phnom_mission_tree_task_8 = { #A Modernising Influence
        requires = { phnom_mission_tree_task_6 phnom_mission_tree_task_7 }
        icon = "task_apollo"
		final = yes
		
        allow = {
            custom_tooltip = {
                text = you_need_to_form_funan_tt
                tag = FNN
            }
            stability >= 70
            }
		
        on_completion = {
            trigger_event = me_phnom.11
            add_country_modifier = {
                name = end_of_phnom_mission_tree_reward_mod
                duration = 7300
            }
        }
    }
	
    phnom_mission_tree_task_9 = { #Markets of [ROOT.GetCountry.GetCapital.GetName]
        icon = "task_economical"

		highlight = {
			scope:province = {
				has_owner = yes
				owner = ROOT
				is_capital = yes
			}
		}
		
        allow = {
            capital_scope = {
				num_of_slave_building >= 1
				num_of_commerce_building >= 1
				civilization_value >= 25
			}
        }
		
        on_completion = {
            trigger_event = me_phnom.12
			capital_scope = {
				create_state_pop = tribesmen
				create_state_pop = tribesmen
				create_state_pop = slaves
				create_state_pop = slaves
			}
			add_country_modifier = {
				name = phnom_renowned_architects
				duration = 7300
			}
        }
    }
	
    phnom_mission_tree_task_10 = { #A System of Canals
        icon = "task_conquest"
		requires = { phnom_mission_tree_task_9 }
		duration = 730

		highlight = {
			scope:province = {
				OR = {
					province_id = 9828
					province_id = 9830
					province_id = 9831
					province_id = 10963
				}
			}
		}
		
        allow = {
			manpower >= 2
			treasury >= 75
			invention = capital_trade_inv_2
        }
		
        on_completion = {
			add_manpower = -2
			add_treasury = -75
            trigger_event = me_phnom.13
			p:9828 = {
				add_road_towards = 9830
			}
			p:9830 = {
				add_road_towards = 9831
			}
			p:9831 = {
				add_road_towards = 10963
			}
        }
    }
	
    phnom_mission_tree_task_11 = { #Sugar Farms Of The South
        icon = "task_happiness"
        requires = { phnom_mission_tree_task_3 phnom_mission_tree_task_9 }
		
        highlight = {
			scope:province = {
				OR = {
					province_id = 9833
					province_id = 9834
					province_id = 9835
				}
			}
		}
		
        allow = {
			p:9833 = {
				num_of_latifundia_building >= 1
				total_population >= 10
			}
            p:9834 = {
				num_of_latifundia_building >= 1
				total_population >= 10
			}
			p:9835 = {
				num_of_latifundia_building >= 1
				total_population >= 10
			}
			owns = 9833
			owns = 9834
			owns = 9835
        }
		
        on_completion = {
			add_2_free_province_investments = yes
            trigger_event = me_phnom.14
            show_as_tooltip = {
				p:9834 = {
					add_province_modifier = {
						name = phnom_sugar_farms_mod
						duration = -1
					}
				}
				p:9835 = {
					add_province_modifier = {
						name = phnom_sugar_farms_mod
						duration = -1
					}
				}
			}
        }
    }
	
    phnom_mission_tree_task_12 = { #The Port of Oc Eo
        icon = "task_calm"
		duration = 730

        requires = { phnom_mission_tree_task_10 phnom_mission_tree_task_11 }
		
		highlight = {
			scope:province = {
				province_id = 10963
			}
		}
		
        allow = {
			political_influence >= 40
			treasury >= 150
			invention = capital_trade_inv_2
			hidden:capital_scope.state = {
				trade_good_surplus = {
					target = stone
					value >= 2
				}
			}
        }
		
        on_completion = {
			p:10963 = {set_city_status = city}
            trigger_event = me_phnom.15
			add_political_influence = -40
			add_treasury = -150
        }
    }
	
	phnom_mission_tree_task_13 = { #Completing the Canals
        icon = "task_atlas"
		duration = 730
        requires = { phnom_mission_tree_task_5 phnom_mission_tree_task_12 }
		
		highlight = {
			scope:province = {
				OR = {
					province_id = 9832
					province_id = 9834
					province_id = 9833
				}
			}
		}
		
        allow = {
			manpower >= 3
			treasury >= 100
			invention = capital_trade_inv_1
        }
		
        on_completion = {
			add_manpower = -3
			add_treasury = -100
			trigger_event = me_phnom.16
			p:9828 = {
				add_road_towards = 9832
			}
			p:9832 = {
				add_road_towards = 9833
			}
			p:9832 = {
				add_road_towards = 9834
			}
			p:9834 = {
				add_road_towards = 9833
			}
			show_as_tooltip = {
			}	
        }
    }
	
	phnom_mission_tree_task_14 = { #Jungle Combat
        icon = "task_artemis"
        requires = { phnom_mission_tree_task_4 phnom_mission_tree_task_11 }
		
        allow = {
			military_tech >= 3
			custom_tooltip = {
				text = phnom_mission_tree_task_14_tt
				has_military_bonus = ti_rong_di_path_13
			}
        }
		
        on_completion = {
            trigger_event = me_phnom.18
            show_as_tooltip = {
				add_country_modifier = {
					name = phnom_jungle_warrior_master_mod
					duration = -1
				}
            }
        }
    }

    phnom_mission_tree_task_15 = { #Embrace The Nats
    requires = { phnom_mission_tree_task_12 }
    icon = "task_religion"

    highlight = {
        scope:province = {
            province_id = 9828
        }
    }
    
    allow = {
        capital_scope = {
            is_holy_site = yes
            has_building = temple_building
        }
        capital_scope.state = {
            amount >= 1   
            state_improvement_religious_trigger = yes      
        }
    }

    on_completion = {
        trigger_event = me_phnom.19
        capital_scope = {
            add_permanent_province_modifier = {
                name = phnom_nat_temple_modifier_reward
            }
        }
    }

    }

}
